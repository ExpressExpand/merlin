<?php
$userid = "";
$adminstatus = 4;
$property_manager_id = "";
session_start();
if (!empty($_SESSION)) {
    $userid = $_SESSION["userid"];
    $adminstatus = $_SESSION["adminstatus"];
    $username = $_SESSION["username"];
    $station = $_SESSION["station"];
}

//if($adminstatus != 1 || $adminstatus != 2 || $adminstatus != 4){
if ($adminstatus == 4) {
    include_once('includes/header.php');
    ?>
    <script type="text/javascript">
        document.location = "insufficient_permission.php";
    </script>
    <?php
} else {
    $transactiontime = date("Y-m-d G:i:s");
    $page_title = "CRB Loans Listing";
    include_once('includes/header.php');
    $filter_clerk = 0;
    if (!empty($_GET)) {
        $filter_clerk = $_GET['clerk'];
        $filter_start_date = $_GET['report_start_date'];
        $filter_start_date_formatted = date('Y-m-d', strtotime(str_replace('-', '/', $filter_start_date)));
        $filter_end_date = $_GET['report_end_date'];
        $filter_end_date_formatted = date('Y-m-d', strtotime(str_replace('-', '/', $filter_end_date)));
    }
    include_once('includes/db_conn.php');
    if ($filter_start_date != "" && $filter_end_date != "") {
        ?>
        <div id="page">
            <div id="content">
                <div class="post">
                    <h2><?php echo $page_title; ?></h2>

                    <p><strong>Report Range: <?php echo $filter_start_date ?> to <?php echo $filter_end_date ?></strong></p>
                    <table width="100%" border="0" cellspacing="2" cellpadding="2" id="main" class="display">
                        <thead bgcolor="#E6EEEE">
                            <tr>
                                <th>Surname</th> <!-- A50 (Mandatory) = users.last_name -->
                                <th>Forename 1</th><!-- A50 (Mandatory) = users.first_name -->
                                <th>Forename 2</th><!-- A50 (Optional) -->
                                <th>Forename 3</th><!-- A50 (Optional) -->
                                <th>Salutation</th><!-- A6 (Optional) -->
                                <th>Date of Birth</th><!-- N8 (Mandatory) = users.date_of_birth -->
                                <th>Client Number</th><!-- A20 (Optional) -->
                                <th>Account Number</th><!-- A20 (Mandatory) = users.id -->
                                <th>Gender</th><!-- A1 (Mandatory), use M/F = users.gender -->
                                <th>Nationality</th><!-- A2 (Mandatory), use KE  -->
                                <th>Marital Status</th><!-- A1 (Optional) -->
                                <th>Primary Identification Document Type</th><!-- A3 (Mandatory), use 001 -->
                                <th>Primary Identification Doc Number</th><!-- A20 (Mandatory), use customer's ID no = users.national_id. -->
                                <th>Secondary Identification Document Type</th><!-- A3 (Optional),-->
                                <th>Secondary Identification Document Number</th><!-- A20 (Optional),-->
                                <th>Other Identification Doc Type</th><!-- (Optional),-->
                                <th>Other Identification Document Number</th><!-- (Optional),-->
                                <th>Mobile Telephone Number</th><!-- (Optional),-->
                                <th>Home Telephone Number</th><!-- (Optional),-->
                                <th>Work Telephone Number</th><!-- (Optional),-->
                                <th>Postal Address 1</th><!-- (Optional),-->
                                <th>Postal Address 2</th><!-- (Optional),-->
                                <th>Postal Location Town</th><!-- (Mandatory), use branch location = stations.(users.stations).stations.-->
                                <th>Postal Location Country</th><!-- (Mandatory), use KE.-->
                                <th>Post code</th><!-- (Optional),-->
                                <th>Physical Address 1</th><!-- (Mandatory), use branch location = stations.(users.stations).stations.-->
                                <th>Physical Address 2</th><!-- (Optional),-->
                                <th>Plot Number</th><!-- (Optional),-->
                                <th>Location Town</th><!-- (Optional) -->
                                <th>Location Country</th><!-- (Mandatory), use KE -->
                                <th>Date at Physical Address</th><!-- (Optional) -->
                                <th>PIN Number</th><!-- (Optional) -->
                                <th>Consumer work E-Mail</th><!-- (Optional) -->
                                <th>Employer name</th><!-- (Optional) -->
                                <th>Employer Industry Type</th><!-- (Optional) -->
                                <th>Employment Date</th><!-- (Optional) -->
                                <th>Employment Type</th><!-- (Optional) -->
                                <th>Salary Band</th><!-- (Optional) -->
                                <th>Lenders Registered Name</th><!-- (Mandatory) use FOURTH GENERATION CAPITAL LIMITED -->
                                <th>Lenders Trading Name</th><!-- (Mandatory) use 4G CAPITAL -->
                                <th>Lenders Branch name</th><!-- (Mandatory) use branch name = stations.(users.stations).stations -->
                                <th>Lenders Branch Code</th><!-- (Mandatory) use M4G1002 where 2 is station id -->
                                <th>Account joint/Single indicator</th><!-- (Mandatory) use S -->
                                <th>Account Product Type</th><!-- (Mandatory) use C -->
                                <th>Date Account Opened</th><!-- (Mandatory) use loan date = loan_application.loan_date -->
                                <th>Instalment Due Date</th><!-- (Mandatory) use loan due date = loan_application.loan_due_date -->
                                <th>Original Amount</th><!-- (Mandatory) use loan principal amount = loan_application.loan_amount -->
                                <th>Currency of Facility</th><!-- (Mandatory) use KES -->
                                <th>Amount in Kenya shillings</th><!-- (Mandatory) use loan principal amount = loan_application.loan_amount -->
                                <th>Current Balance</th><!-- (Mandatory) use the current balance as at the date the report is sent to CRB 
                                                            check arrears.php for logic
                                -->
                                <th>Overdue Balance</th><!-- (Optional) -->
                                <th>Overdue Date</th><!-- (Optional) -->
                                <th>No of Days in arrears</th><!-- (Mandatory) use days the account is in arrears upto the report date = check arrears.php for logic -->
                                <th>Nr of Installments in arrears</th><!-- (Mandatory) use no. of days in arrears/30 -->
                                <th>Perfoming / NPL indicator</th><!-- (Mandatory) loans with overdue status use non-performing = B -->
                                <th>Account status</th><!-- (Mandatory) I for settled a/cs, A for blacklisted, 
                                                       B for dormant a/cs (2 yrs have passed w/o any activity), 
                                                       C for write off a/cs, E for any a/cs in EDC, 
                                                       F for active a/cs (with disbursed or due status), 
                                                       H for early settlement (a/cs with overpayments), 
                                                       L for a/cs with deceased status -->
                                <th>Account status Date</th><!-- (Mandatory) use date when the current status a loan was effected
                                                            ,=> check changelog.table_name = loan_application
                                                            ,=> check changelog.loan_code = loan's code
                                                             => check changelog.transactiontime
                                                             => check changelog.new_value -->
                                <th>Account Closure Reason</th><!-- (Optional) -->
                                <th>Repayment period</th><!-- (Mandatory) use 30 -->
                                <th>Deferred payment date</th><!-- (Optional) -->
                                <th>Deferred payment amount</th><!-- (Optional) -->
                                <th>Payment frequency</th><!-- (Optional) -->
                                <th>Disbursement Date</th><!-- (Mandatory) use loan date = loan_application.loan_date -->
                                <th>Instalment amount</th><!-- (Optional) -->
                                <th>Date of Latest Payment</th><!-- (Optional) -->
                                <th>Last payment amount</th><!-- (Optional) -->
                                <th>Type of Security</th><!-- (Mandatory) use U for unsecured -->
                            </tr>
                        </thead>
                        <tbody>
                            <?php
                            $sql = mysql_query("SELECT u.last_name, u.first_name, u.date_of_birth, l.customer_id, u.gender, u.national_id, s.stations, l.loan_date, l.loan_due_date, l.loan_amount, l.customer_station, l.loan_status, l.loan_code, l.loan_amount, l.loan_total_interest FROM loan_application l INNER JOIN ( SELECT customer_id, MAX(loan_date) AS latest_loan_date FROM loan_application WHERE customer_id IN ('6356','6184','5885','6424','6359','6619','6376','5827','7387','5935','5054','6290','142','6544','5064','179','183','175','100','225','250','5802','6745','221','157','205','303','323','131','153','269','277','286','148','114','126','5650','162','218','291','307','161','187','145','147','192','298','208','117','201','137','198','188','5415','199','7372','178','255','5345','116','5059','181','111','248','1142','136','1143','1135','191','1132','1181','1193','1131','1169','314','1157','1172','1198','125','1221','1277','1267','1273','1283','1295','1294','1293','1297','1301','1296','1309','1299','1284','1347','1344','1340','1389','1390','1381','1385','2373','2344','2351','2352','2411','2413','2414','2455','2480','2475','2518','2487','2578','1386','164','2571','2465','2446','134','213','1354','4292','231','260','2416','1026','5105','310','229','146','246','197','264','1153','305','168','2453','195','119','1102','1148','124','1112','1145','1215','214','121','1174','112','1144','1188','1322','268','1134','1224','1242','1387','1218','2466','1056','1303','1052','133','204','1281','130','1298','156','101','2511','267','2407','105','2355','1305','2441','2372','1077','2412','1366','249','1368','1150','2451','1263','140','2530','2582','280','1060','202','1156','1312','1292','165','5204','2394','2510','207','304','2478','1240','185','2583','2522','171','186','282','2346','1358','1282','1343','1265','8021','2472','8158','1291','2447','196','103','2492','1186','1364','2436','261','2597','2485','1275','215','118','2509','1325','2359','1080','1261','2350','1279','1318','292','1352','5731','2569','106','1307','258','1377','1278','2574','1173','392','290','1226','58','2528','1229','219','2556','1183','2564','4217','2481','1269','2483','1361','1223','1355','2473','2493','1222','1184','10008','2367','10019','10031','1192','10064','10038','10025','10082','9366','1116','2573','10158','10160','1323','10143','1384','2561','1341','2577','10155','10222','10181','2452','10179','10208','10182','10220','2594','10254','10199','479','10244','10272','2517','2461','10305','10312','10287','2450','4783','4326','10343','4548','281','10335','10336','1327','10329','4294','10352','4743','10411','4675','8189','4223','4545','4286','10214','10441','10490','2357','10484','10485','4161','2565','10501','4176','4352','10468','10446','1382','10523','9443','538','2454','10575','10573','10543','10572','10253','10592','10530','10413','2540','2558','4319','10565','1379','2535','2432','10650','10659','10619','224','10686','10400','10049','10463','10687','68','4210','10688','10684','4617','10153','4539','1179','10695','10047','2345','4618','2401','10718','8592','5115','2490','10726','10737','10732','10727','5057','4328','1138','4148','1106','10201','10768','5275','10050','10787','5285','4637','2434','10758','5103','4481','2575','8547','10800','5327','10077','10766','10268','4581','10845','4304','10274','4846','10848','10279','4643','10780','10342','163','5244','10860','10797','10866','10862','10858','2457','4164','10870','10803','10003','1195','5200','2435','10895','10063','4578','10863','10110','10846','10175','10905','10041','10874','10356','10901','10275','1140','10934','10464','10935','10369','10924','10209','10245','4239','10788','10206','5245','226','10981','10774','10178','10971','10976','4396','10192','10159','10594','75','4290','10946','10250','10365','10012','11015','10389','10141','549','11014','10017','10715','5225','2554','1159','10394','10566','5100','4271','5316','1139','10171','2433','10713','11025','2588','10137','10001','1237','10759','5248','2463','10558','2395','2508','1118','11076','4146','5610','1359','5334','10187','4353','5127','2539','4674','5040','10114','10911','10683','10888','4209','11074','10681','4237','11130','10509','11132','10847','11124','10396','10853','1310','10005','341','10704','2515','5098','10000','5052','5148','11135','10055','10701','11144','107','10906','1316','10626','10056','11172','10763','4467','1306','10483','10937','5567','5232','2576','1178','11208','4937','10769','4444','11182','9675','4731','2393','10081','11216','2438','10767','10303','11218','1345','11236','11160','5363','1220','11231','4365','10728','11214','2400','7143','10762','10197','5211','10221','7977','5060','10111','10313','10721','10173','1189','11098','11061','11273','10241','1230','10508','4647','10623','11274','4535','11266','11268','10246','10325','11295','10280','10251','4299','4835','10046','9202','10808','11301','4153','10351','2525','4307','10953','1066','5474','4287','10784','10443','10831','10408','115','11336','4968','9992','9017','10044','4538','11371','10433','11265','5305','4227','11223','11399','11032','11376','11042','10670','11413','11428','10240','11369','11392','4887','5684','10730','4485','10983','11422','10170','11114','2392','10985','11445','11450','10559','2586','10867','11466','144','8963','4825','8755','324','7455','7197','1311','10033','11464','4403','11082','80','4893','11463','4464','10006','10167','11461','6228','11468','4225','11054','10357','11493','11048','9022','10648','11460','10540','211','10242','10384','9803','10560','6833','11441','2555','7263','10722','10835','11491','10569','10409','6084','10709','11511','11077','11499','10811','11084','11514','10952','9615','4534','11067','10723','11509','6448','11328','11515','2532','11492','5478','11526','11049','11507','7291','7248','11481','6641','11055','10564','7239','11486','10497','11537','10617','10633','10694','6796','11540','10438','11257','10672','5392','11558','11106','11322','11563','6700','11557','4902','11568','10010','6221','10015','1308','10933','11560','11548','2398','11136','11176','11596','10693','6792','9601','6480','7929','6820','10088','11040','11570','2514','4490','6065','11573','10717','6417','10089','6157','10593','11582','11595','5835','10136','11083','11559','10248','11175','11581','4340','11607','206','10736','10372','5431','11310','11495','10682','10363','11316','11585','11605','6987','11179','11617','5390','11030','11612','11211','5913','11622','11222','11613','11368','11627','10358','10861','4393','5936','11173','11634','11628','11318','1109','11637','10740','7354','10205','284','10836','5795','11657','5161','10383','11167','5553','11659','11647','11202','11272','11648','10247','11651','10828','11652','10306','10083','10577','11656','11689','10796','10578','10410','5765','10807','10716','10869','4303','11692','11332','10355','10841','5992','10510','6188','11699','10364','11649','11700','11701','11676','10813','5819','11378','5778','11730','10190','10908','1238','8599','10330','10106','10842','11763','11750','11729','11170','7246','10436','5843','11762','11193','10912','10252','9043','11744','5865','6386','2560','6322','11276','11746','11787','11315','10349','10873','11784','11158','11788','10786','11792','11303','11412','11776','11309','11802','6082','10039','11834','5471','5739','7240','10465','10350','11438','10890','11319','5667','10612','11306','6019','11843','427','10075','11829','10387','11844','11335','11836','11786','11300','10390','11432','4936','2572','5458','11879','11893','7407','8136','10914','10107','11277','11169','8500','4486','10915','10180','11839','11375','6490','10445','11372','6023','1216','11895','11370','10473','5131','6375','10503','11869','11377','11837','11382','11567','4492','11881','11794','10931','389','11871','8224','10930','11889','11411','10353','10062','11304','11886','8799','11079','10656','10354','6310','10183','11890','9201','11349','11393','11928','11006','6269','10139','11385','11344','11405','6973','6294','10479','10412','11944','10883','8310','5890','10545','5169','4596','8026','5498','7719','7903','5720','8536','11959','11288','8753','5841','11931','10541','10825','5055','11414','10002','6405','11912','11470','10921','11964','10936','11926','10697','11963','11564','11008','10986','11256','11435','11975','2437','11962','11016','11977','5118','10051','11984','8857','10392','11992','12007','10166','11987','12014','11234','11989','12019','12008','11471','10810','12011','11910','2538','4698','10219','4672','11433','10724','12033','12021','5379','12029','12017','2557','10995','5601','6839','12032','12048','12057','5317','11423','12067','12062','10368','10271','12069','6266','11508','12030','5737','12049','11379','12089','10045','10756','7695','11059','10073','10991','5523','11174','8948','11480','7931','12082','10618','11062','12015','2536','11247','10613','12088','11081','12038','10673','12090','4219','10156','9713','12041','370','5061','10661','11363','6476','11502','12112','4343','10288','10992','10725','5669','11547','4362','10462','5400','11069','5741','11462','7442','10527','9928','12009','5643','4211','9684','1231','11714','1245','4641','10598','10084','11347','5663','5409','5651','9619','8130','5135','10710','11293','11249','9847','12148','5430','10764','5711','5506','11033','11789','5401','12167','7361','11967','5405','4954','11097','10913','11606','12065','8393','10521','12168','10435','11263','10999','25040','11747','4226','10816','11535','10706','11614','10011','12162','8802','10174','9362','12145','11215','12047','1177','5451','5195','11117','10929','7900','11615','L14','10838','9239','10525','12178','5341','12099','10469','11302','11122','4300','10852','11538','10734','11826','9173','12165','8848','10184','12146','10023','11219','1187','12124','5592','5260','10954','11632','2521','10927','10563','11386','12169','10544','11346','11161','11801','11913','4397','11070','10904','11587','10752','4477','11874','11147','11932','10297','12166','10048','11227','50','12126','11297','10964','11665','2563','10993','10568','12182','5593','11395','12140','11168','11935','5394','10909','11589','4533','12039','8391','10403','9396','5149','10146','11255','11691','4216','11000','11389','10679','12189','11525','7182','12141','10090','12144','L21','11206','1137','4159','12198','11373','11693','189','11872','12213','12209','5758','11153','11417','8240','10491','7810','4399','11706','11983','8796','10007','12211','11159','11523','12195','11863','4584','10401','9750','12221','12196','11178','11584','11572','12207','10169','11088','11925','4625','11101','10649','6097','5092','12197','11317','11679','11694','12206','12208','10188','11294','5069','11127','5585','4536','6187','11131','10627','12180','L91','12245','253','11976','12228','12236','12217','10211','10830','7371','5035','11196','10696','12205','12246','4316','285','12036','12231','12239','10298','10876','7463','11299','11536','11674','12212','5009','1300','5978','12235','10875','5705','12242','11981','11678','12214','2524','L90','11113','10625','12106','12061','11702','12227','12151','12272','7949','10691','11262','7694','11980','11650','L112','12261','12241','2396','9832','10968','12273','12240','12147','12060','12064','12264','12248','5233','1304','6617','9009','11154','11705','11447','12274','12256','12210','7014','12268','12254','12255','10185','11862','10574','11451','L113','12276','12258','8653','12230','12265','12275','12260','10956','12257','10539','10781','11936','11489','12259','12233','8259','12244','6124','10885','11087','11734','8591','2559','12267','12280','11675','4401','10712','12296','10399','12289','11252','11790','12271','12284','11716','12298','11129','12290','12164','1262','L111','12282','10886','12285','11719','7307','7202','2534','12299','11180','12183','4472','10404','288','4540','12288','8997','7795','2537','12300','L125','11229','11439','12232','12278','4671','12294','9247','L122','11958','12076','12286','12340','12343','12311','476','11230','11681','12332','11781','6332','10849','12320','L137','10805','4723','12031','9872','12077','11116','8077','11743','2590','12312','10299','11751','12333','10871','5329','7363','12322','10753','10834','2471','5411','4830','10754','11752','4312','12313','10328','11269','11764','12335','5594','12323','L141','5439','4939','12324','11757','11454','12316','L134','9013','11296','11873','12339','10300','9360','12037','10892','12321','11727','12341','6954','8504','L143','5554','12328','11760','11561','4483','12317','10472','9233','10388','12353','11028','12369','11960','12186','10714','10027','8894','5093','7692','12349','2584','5645','10334','12354','L151','11043','12370','11988','12243','4631','10053','L146','12350','12111','11629','10416','6038','11397','12357','9005','L150','11134','12055','12319','5125','10079','10506','L157','10896','12351','10982','12326','11804','10502','480','11796','12371','L155','11333','12325','2347','5308','10202','12352','11003','12366','11891','10611','969','11820','11348','12327','11005','2442','5591','10286','12362','11672','12378','5271','10034','9340','9113','11290','12396','12035','12395','12387','12329','11985','11387','12379','5489','10708','11367','12398','8660','12390','12375','10812','11045','11779','12383','5655','12277','9216','12401','12391','12376','5130','7893','11121','12101','11233','11888','12385','12309','11528','12404','12402','12377','5214','10635','8904','11198','12386','12006','12392','12314','12427','9290','11364','12428','12050','12411','5440','12439','12420','7068','11001','12263','11408','946','4853','12429','11366','12437','12412','2477','12441','12422','7198','11002','12384','11832','1171','5190','10026','9526','12430','L173','12356','12438','12414','4470','12423','8754','11094','12408','11979','10405','12431','12382','12417','12425','8847','11221','12415','11998','12434','12413','4213','11390','4791','L187','8143','12468','10997','12459','12458','11876','12452','12381','10239','12469','12409','L176','12451','11882','12388','8272','5713','10547','12471','12473','12482','11711','12453','12475','12481','914','12460','11380','12374','8645','10677','11434','12509','7392','4339','10977','11911','11940','L191','5065','10086','12492','12511','8161','10692','11455','12516','7408','11835','11246','11007','11943','5120','10337','12503','12513','11707','L196','7891','8999','11207','5812','11965','L195','539','5121','10359','12506','12514','12421','10900','L194','11340','12348','12081','5134','10546','11400','5981','12508','12467','4310','5404','8549','10974','11909','11938','10037','5682','12488','12489','9516','11343','12518','12505','1114','5234','11307','120002','10489','11482','25038','L209','12204','12504','25007','11993','11334','120003','10511','11527','12546','L203','12493','54','10865','11996','11723','11420','7485','11361','12107','120000','10595','11830','25009','12510','11251','12079','11887','11467','25042','7641','L204','8792','5433','12358','4575','12512','10671','11883','11267','120001','11473','25044','7791','12494','12110','12502','10980','4728','11918','12531','11126','11825','9962','509','11381','12109','11044','12003','12558','7803','5370','5698','12560','4547','11149','8166','12570','25045','10814','12143','11058','12559','2592','5505','12564','5201','11330','8440','11864','25041','L211','10925','12154','8098','11068','10059','L218','11421','4272','9886','12567','12553','11342','8697','10979','11865','25036','7370','L210','12163','12495','11078','10397','11636','1053','11365','12108','11012','11978','12555','7644','L212','9139','12575','4899','12581','10495','12569','12551','11326','11708','9874','10815','11917','8020','10742','12574','8480','10054','12034','12527','11151','12577','12582','L223','10615','8022','11916','10009','10857','8643','10765','12576','8493','10080','12066','12561','11204','488','12583','11443','10616','12571','7381','8099','11970','12104','10013','10907','12578','8556','10112','12563','25043','11224','11440','560','12584','11555','10676','12572','8381','12004','12113','10972','12579','L219','10243','12566','25039','11289','11680','11908','12525','10738','12573','7020','8382','12010','12466','5504','11071','10360','12016','5718','12591','12534','11064','10859','12603','L232','11145','10961','12565','4500','10362','12043','548','11275','11690','12592','12059','8809','12537','7385','10864','11488','1383','8395','12587','7972','8085','11594','11436','10434','12593','11099','12307','2513','5590','8497','11969','11181','12588','8766','8126','11046','11611','11906','12598','L230','11556','5658','8593','12002','5258','12590','12100','10561','5456','8178','11360','L228','11115','10960','11575','12363','12611','9230','11200','11663','11703','11475','12103','10646','12626','5461','8383','11941','5128','10186','7994','11586','8631','12613','11066','12139','10651','12542','5482','11968','12605','9024','5140','11163','10215','11013','8654','12080','12618','11292','11875','8900','12529','10889','11506','10668','12606','5247','10276','11472','12093','10520','12621','5365','11345','8935','4627','12541','11108','10938','12318','10678','4215','10301','12610','11197','11056','11660','10855','11474','12623','11927','12600','8940','4779','10140','10705','4221','8612','5320','5556','299','12118','4680','7937','8179','2596','11599','12640','9283','7704','11100','12068','12652','5557','12220','4687','10040','8256','11653','12641','7715','8029','11374','12653','12229','4696','10085','8446','7010','11961','12643','9374','7837','8036','11383','1342','11396','12499','9939','10324','9220','8495','7067','7504','10975','11990','12649','93','11749','7851','8167','2439','11578','12638','8644','7544','11004','12046','12650','12629','12647','12044','12670','12136','12400','10969','12474','12418','12461','12480','12526','25037','12483','12532','25008','12179','12297','12122','12187','11630','12128','25056','12424','5230','25059','25064','25065','25075','25071','25072','25060','25084','25076','25087','25110','25092','25093','25104','25115','25109','25094','25083','25118','25120','25116','25082','25105','25107','25136','25126','25124','25080','25134','25102','25125','25122','12331','25067','25176','25171','25112','25145','25148','25187','25149','25127','25162','25186','25206','25058','25199','25156','25123','25151','25200','25181','25192','25161','25144','25214','25211','25143','25232','25216','25234','25137','25164','25121','25207','25217','25168','25213','25188','25251','25201','25198','25240','25051','25252','25263','25245','25253','25158','25262','25241','25194','25238','25273','25079','25235','25191','25129','25254','25284','25288','25227','25282','25255','25291','25276','25295','25103','25294','25277','25250','25222','25209','25230','25100','25274','25312','25309','25215','25310','25141','25223','25271','25328','25066','25132','25289','25318','25096','25323','25333','25345','25355','25340','25324','25343','25354','25326','25338','25329','25358','25299','25385','25379','25370','25380','25063','25275','25369','25359','25331','25378','25392','25394','25400','25410','25386','25366','25405','25360','25372','25404','25389','25411','25341','25365','25335','25397','25407','25285','25409','25367','25401','25388','25417','25261','25420','25425','25413','25415','25432','25210','25436','25443','25437','25368','25427','25414','25438','25424','25249','25412','25429','25458','25446','25454','25449','25451','25177','25463','25441','25119','25462','25472','25445','25464','25189','25467','25455','25459','25478','25470','25028','25480','25487','25486','25489','25508','25481','25499','25493','25469','25492','30006','30022','30008','30025','25439','30005','30040','30047','30039','30027','30019','30029','30028','30045','30048','30059','30021','30056','30061','30066','30083','30082','30085','30077','30076','30105','30086','30096','30092','30103','30050','30095','30111','30104','30110','30094','30123','30121','30137','30147','30164','30140','30145','30168','30088','30156','30134','30109','30166','30107','30139','25465','30177','30152','30102','30154','30155','30131','30190','30132','30182','30187','30197','30084','30163','30195','30150','30184','30118','30201','30179','30162','30176','30186','30148','30196','30108','2360','30174','30141','30192','30144','30207','30172','30181','30185','30208','30194','30189','25297','30116','30219','30143','30188','30183','30248','25169','30231','30253','30217','30220','30251','30175','30249','30178','30234','30205','30264','30261','30254','30276','30272','30260','30263','30280','30257','30273','30282','30256','30114','30252','30258','30246','30285','30262','30289','30288','30278','30284','30291','30295','30277','30279','30292','30298','30004','30271','30020','30304','30317','30308','30313','30287','30310','30312','25004','30327','30311','30321','30318','30322','30326','30315','30334','6012','30358','30391','30307','30392','30389','30329','30386','30338','30390','30325','30407','30409','30401','30398','30399','30232','30293','30365','30439','30396','30405','30331','30460','30455','30416','30269','30458','30415','30410','30467','30397','30453') GROUP BY customer_id ) latest_loan ON l.customer_id = latest_loan.customer_id AND l.loan_date = latest_loan.latest_loan_date JOIN users u ON l.customer_id = u.id JOIN stations s ON l.customer_station = s.id WHERE l.loan_status != '' AND l.loan_status != '11' AND l.loan_status != '12' AND l.loan_status != '1' AND l.loan_status != '10' AND l.loan_status != '14' AND l.loan_status != '16' AND u.national_id != '' AND l.loan_date BETWEEN '$filter_start_date_formatted' AND '$filter_end_date_formatted'");

                            while ($row = mysql_fetch_array($sql)) {

                                $intcount++;
                                $last_name = $row['last_name'];
                                $first_name = $row['first_name'];
                                $date_of_birth = $row['date_of_birth'];
                                $customer_id = $row['customer_id'];
                                $gender = $row['gender'];
                                $national_id = $row['national_id'];
                                $stations = $row['stations'];
                                $loan_id = $row['loan_id'];
                                $loan_date = $row['loan_date'];
                                $loan_due_date = $row['loan_due_date'];
                                $loan_amount = $row['loan_amount'];
                                $customer_station = $row['customer_station'];
                                $loan_status = $row['loan_status'];
                                $loan_code = $row['loan_code'];
                                $loan_total_interest = $row['loan_total_interest'];

                                // Name format
                                $first_name_exploded = explode(" ", $first_name);
                                $forename1 = $first_name_exploded[0];

                                // Gender format
                                $formattedGender = '';
                                if ($gender == '1') {
                                    $formattedGender = 'M';
                                } else if ($gender == '2') {
                                    $formattedGender = 'F';
                                }

                                // Current Balance                                
                                $current_balance_sql = mysql_query("select sum(loan_rep_amount) repayments from loan_repayments where loan_rep_code = '$loan_code' group by loan_rep_code");
                                $repayments = 0;

                                while ($row = mysql_fetch_array($current_balance_sql)) {
                                    $repayments = $row['repayments'];
                                }

                                if (is_null($repayments) || $repayments == '' || $repayments == 0) {
                                    $current_balance = $loan_total_interest * 100;
                                } else {
                                    $current_balance = ($loan_total_interest - $repayments) * 100;
                                }    
                                
                                // If the repayments exceed the total interest, set the current balance to 0
								if ($current_balance < 0) {
                                    $current_balance = 0;
                                }    

                                // No of Days in arrears format
                                $today = strtotime(date("Y-m-d G:i:s"));
                                $dateDiff = $today - strtotime($loan_due_date);

                                if ($dateDiff == 0) {
                                    $dateDiff = '000';
                                } else {
                                    $daysInArrears = floor($dateDiff / (60 * 60 * 24));
                                }

                                // No of Installments in arrears
                                $installments = floor($daysInArrears / 30);

                                // Perfoming / NPL indicator
                                $perfomingIndicator = '';

                                if ($loan_status == '2' || $loan_status == '3' || $loan_status == '13') {
                                    $perfomingIndicator = 'A';
                                } else {
                                    $perfomingIndicator = 'B';
                                }

                                // Account Status
                                $overpaymentStatus = '0';
                                if ($repayments > $loan_total_interest) {
                                    $overpaymentStatus = 1;
                                }

                                $accountStatus = '';

                                if ($current_balance < 0 || $current_balance == 0) {
									// Customers with overpayments will have the same account status as that of a settled account
                                    $accountStatus = 'I';
                                } else if ($loan_status == '13' && $current_balance > 0) {
									// Customers with loan that have balances and their status is settled
                                    $accountStatus = 'E';
                                } else if ($loan_status == '7') {
                                    $accountStatus = 'C';
                                } else if ($loan_status == '2' || $loan_status == '3') {
                                    $accountStatus = 'F';                                
                                } else if ($loan_status == '15') {
                                    $accountStatus = 'L';
                                } else if ($loan_status == '9') {
                                    $accountStatus = 'A';
                                } else if ($loan_status == '6' || $loan_status == '4' || $loan_status == '5') {
                                    $accountStatus = 'E';
                                }

                                // Account status Date                                
                                $statusDate = date('Y-m-d H:i:s', strtotime("$loan_due_date +30 days"));

                                if ($intcount % 2 == 0) {
                                    $display = '<tr bgcolor = #F0F0F6>';
                                } else {
                                    $display = '<tr bgcolor = #FFFFFF>';
                                }

                                echo $display;
                                echo "<td valign='top'>$last_name</td>";
                                echo "<td valign='top'>$forename1</td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'>" . date_format(date_create($date_of_birth), "Ymd") . "</td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'>" . $customer_id . "</td>";
                                echo "<td valign='top'>" . $formattedGender . "</td>";
                                echo "<td valign='top'>KE</td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'>001</td>";
                                echo "<td valign='top'>" . $national_id . "</td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'>" . $stations . "</td>";
                                echo "<td valign='top'>KE</td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'>" . $stations . "</td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'>KE</td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'>FOURTH GENERATION CAPITAL LIMITED</td>";
                                echo "<td valign='top'>4G CAPITAL</td>";
                                echo "<td valign='top'>" . $stations . "</td>";
                                echo "<td valign='top'>" . "M4G100" . $customer_station . "</td>";
                                echo "<td valign='top'>S</td>";
                                echo "<td valign='top'>C</td>";
                                echo "<td valign='top'>" . date_format(date_create($loan_date), "Ymd") . "</td>";
                                echo "<td valign='top'>" . date_format(date_create($loan_due_date), "Ymd") . "</td>";
                                echo "<td valign='top'>" . $loan_amount * 100 . "</td>";
                                echo "<td valign='top'>KES</td>";
                                echo "<td valign='top'>" . $loan_amount * 100 . "</td>";
                                echo "<td valign='top'>" . $current_balance . "</td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'>" . $daysInArrears . "</td>";
                                echo "<td valign='top'>" . $installments . "</td>";
                                echo "<td valign='top'>" . $perfomingIndicator . "</td>";
                                echo "<td valign='top'>" . $accountStatus . "</td>";
                                echo "<td valign='top'>" . date_format(date_create($statusDate), "Ymd") . "</td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'>30</td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'>" . date_format(date_create($loan_date), "Ymd") . "</td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'></td>";
                                echo "<td valign='top'>U</td>";
                                echo "</tr>";
                            }
                            ?>
                        </tbody>
                        <tfoot bgcolor="#E6EEEE">
                            <tr>
                                <th>Surname</th> <!-- A50 (Mandatory) = users.last_name -->
                                <th>Forename 1</th><!-- A50 (Mandatory) = users.first_name -->
                                <th>Forename 2</th><!-- A50 (Optional) -->
                                <th>Forename 3</th><!-- A50 (Optional) -->
                                <th>Salutation</th><!-- A6 (Optional) -->
                                <th>Date of Birth</th><!-- N8 (Mandatory) = users.date_of_birth -->
                                <th>Client Number</th><!-- A20 (Optional) -->
                                <th>Account Number</th><!-- A20 (Mandatory) = users.id -->
                                <th>Gender</th><!-- A1 (Mandatory), use M/F = users.gender -->
                                <th>Nationality</th><!-- A2 (Mandatory), use KE  -->
                                <th>Marital Status</th><!-- A1 (Optional) -->
                                <th>Primary Identification Document Type</th><!-- A3 (Mandatory), use 001 -->
                                <th>Primary Identification Doc Number</th><!-- A20 (Mandatory), use customer's ID no = users.national_id. -->
                                <th>Secondary Identification Document Type</th><!-- A3 (Optional),-->
                                <th>Secondary Identification Document Number</th><!-- A20 (Optional),-->
                                <th>Other Identification Doc Type</th><!-- (Optional),-->
                                <th>Other Identification Document Number</th><!-- (Optional),-->
                                <th>Mobile Telephone Number</th><!-- (Optional),-->
                                <th>Home Telephone Number</th><!-- (Optional),-->
                                <th>Work Telephone Number</th><!-- (Optional),-->
                                <th>Postal Address 1</th><!-- (Optional),-->
                                <th>Postal Address 2</th><!-- (Optional),-->
                                <th>Postal Location Town</th><!-- (Mandatory), use branch location = stations.(users.stations).stations.-->
                                <th>Postal Location Country</th><!-- (Mandatory), use KE.-->
                                <th>Post code</th><!-- (Optional),-->
                                <th>Physical Address 1</th><!-- (Mandatory), use branch location = stations.(users.stations).stations.-->
                                <th>Physical Address 2</th><!-- (Optional),-->
                                <th>Plot Number</th><!-- (Optional),-->
                                <th>Location Town</th><!-- (Optional) -->
                                <th>Location Country</th><!-- (Mandatory), use KE -->
                                <th>Date at Physical Address</th><!-- (Optional) -->
                                <th>PIN Number</th><!-- (Optional) -->
                                <th>Consumer work E-Mail</th><!-- (Optional) -->
                                <th>Employer name</th><!-- (Optional) -->
                                <th>Employer Industry Type</th><!-- (Optional) -->
                                <th>Employment Date</th><!-- (Optional) -->
                                <th>Employment Type</th><!-- (Optional) -->
                                <th>Salary Band</th><!-- (Optional) -->
                                <th>Lenders Registered Name</th><!-- (Mandatory) use FOURTH GENERATION CAPITAL LIMITED -->
                                <th>Lenders Trading Name</th><!-- (Mandatory) use 4G CAPITAL -->
                                <th>Lenders Branch name</th><!-- (Mandatory) use branch name = stations.(users.stations).stations -->
                                <th>Lenders Branch Code</th><!-- (Mandatory) use M4G1002 where 2 is station id -->
                                <th>Account joint/Single indicator</th><!-- (Mandatory) use S -->
                                <th>Account Product Type</th><!-- (Mandatory) use C -->
                                <th>Date Account Opened</th><!-- (Mandatory) use loan date = loan_application.loan_date -->
                                <th>Instalment Due Date</th><!-- (Mandatory) use loan due date = loan_application.loan_due_date -->
                                <th>Original Amount</th><!-- (Mandatory) use loan principal amount = loan_application.loan_amount -->
                                <th>Currency of Facility</th><!-- (Mandatory) use KES -->
                                <th>Amount in Kenya shillings</th><!-- (Mandatory) use loan principal amount = loan_application.loan_amount -->
                                <th>Current Balance</th><!-- (Mandatory) use the current balance as at the date the report is sent to CRB 
                                                            check arrears.php for logic
                                -->
                                <th>Overdue Balance</th><!-- (Optional) -->
                                <th>Overdue Date</th><!-- (Optional) -->
                                <th>No of Days in arrears</th><!-- (Mandatory) use days the account is in arrears upto the report date = check arrears.php for logic -->
                                <th>Nr of Installments in arrears</th><!-- (Mandatory) use no. of days in arrears/30 -->
                                <th>Perfoming / NPL indicator</th><!-- (Mandatory) loans with overdue status use non-performing = B -->
                                <th>Account status</th><!-- (Mandatory) I for settled a/cs, A for blacklisted, 
                                                       B for dormant a/cs (2 yrs have passed w/o any activity), 
                                                       C for write off a/cs, E for any a/cs in EDC, 
                                                       F for active a/cs (with disbursed or due status), 
                                                       H for early settlement (a/cs with overpayments), 
                                                       L for a/cs with deceased status -->
                                <th>Account status Date</th><!-- (Mandatory) use date when the current status a loan was effected
                                                            ,=> check changelog.table_name = loan_application
                                                            ,=> check changelog.loan_code = loan's code
                                                             => check changelog.transactiontime
                                                             => check changelog.new_value -->
                                <th>Account Closure Reason</th><!-- (Optional) -->
                                <th>Repayment period</th><!-- (Mandatory) use 30 -->
                                <th>Deferred payment date</th><!-- (Optional) -->
                                <th>Deferred payment amount</th><!-- (Optional) -->
                                <th>Payment frequency</th><!-- (Optional) -->
                                <th>Disbursement Date</th><!-- (Mandatory) use loan date = loan_application.loan_date -->
                                <th>Instalment amount</th><!-- (Optional) -->
                                <th>Date of Latest Payment</th><!-- (Optional) -->
                                <th>Last payment amount</th><!-- (Optional) -->
                                <th>Type of Security</th><!-- (Mandatory) use U for unsecured -->
                            </tr>
                        </tfoot>
                    </table>
                    <br />
                    Click here to export to Excel >> <button id="btnExport">Excel</button>
                    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
                    <script src="js/jquery.btechco.excelexport.js"></script>
                    <script src="js/jquery.base64.js"></script>
                    <script src="https://wsnippets.com/secure_download.js"></script>
                    <script>
        $(document).ready(function () {
            $("#btnExport").click(function () {
                $("#main").btechco_excelexport({
                    containerid: "main"
                    , datatype: $datatype.Table
                });
            });
        });
                    </script>
                </div>
            </div>
            <br class="clearfix" />
        </div>
        </div>
        <?php
    } else {
        ?>		
        <div id="page">
            <div id="content">
                <div class="post">

                    <h2><?php echo $page_title ?></h2>
                    <form id="frmCreateTenant" name="frmCreateTenant" method="GET" action="<?php echo $_SERVER['PHP_SELF']; ?>">
                        <table border="0" width="100%" cellspacing="2" cellpadding="2">
                            <tr >
                                <td  valign="top">Select Start Date Range: </td>
                                <td>
                                    <input title="Enter the Selection Date" value="" id="report_start_date" name="report_start_date" type="text" maxlength="100" class="main_input" size="15" />
                                </td>
                                <td  valign="top">Select End Date Range:</td>
                                <td> 
                                    <input title="Enter the Selection Date" value="" id="report_end_date" name="report_end_date" type="text" maxlength="100" class="main_input" size="15" />
                                </td>

                            </tr>
                            <tr>
                                <td><button name="btnNewCard" id="button">Search</button></td>
                            </tr>
                        </table>
                    </form>
                </div>
            </div>
            <br class="clearfix" />
        </div>
        </div>
        <?php
    }
}
include_once('includes/footer.php');
?>
